name: PR Commit Lint

on:
  pull_request:
    branches:
      - main

jobs:
  lint-commits:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Fetch all commits
        run: git fetch --prune --unshallow

      - name: Check commit messages
        run: |
          commits=$(git log origin/main..HEAD --pretty=format:"%H")
          for commit in $commits; do
            echo "Checking commit $commit"
            commit_msg=$(git show --quiet --pretty=format:%B $commit)
            echo "$commit_msg"
            if ! echo "$commit_msg" | grep -iqE '^(feat|fix|docs|style|refactor|perf|test|chore|BREAKING CHANGE): .{1,50}'; then
              echo "ERROR: Commit message does not follow the conventional format."
              echo "Allowed types: feat, fix, docs, style, refactor, perf, test, chore, BREAKING CHANGE"
              exit 1
            fi
          done
